# Инсайты по апсетам — План и реализация

## 1. Апсеты по всем командам

### Бизнес-логика

Для каждой команды рассчитывается:

- Общее количество игр, в которых есть котировки
- Количество апсетов (если команда выиграла матч, будучи андердогом по котировкам)
- Доля апсетов в процентах (`upset_rate`)
- Статус попадания в плей-офф

### Методика

- Апсет определяется через функцию `is_upset_relative(quote_team, quote_opponent, percent_diff=0.25)`, 
  если коэффициент на победу команды минимум на 25% выше, чем у соперника.
- Используемые источники данных:
  - Таблицы: `Games`, `Quotes`, справочник `Team`
  - Определение плей-офф через функцию `get_playoff_teams()`
- Все матчи сезона учитываются (включая регулярный чемпионат и плей-офф, без предсезонки)

---

## 2. Лидеры по апсетам

### Бизнес-логика

- Используется результат из предыдущего блока (апсеты по всем командам)
- Команды сортируются по `upset_rate` по убыванию
- Отбирается топ-7 команд с наивысшим процентом апсетов

### Отображение

- Отдельная таблица с колонками:
  - `Team`, `Games`, `Upsets`, `Upset %`, `Playoff`
- Используются те же расчёты и функции, что и в общем апсет-блоке

---

## 3. Домашние апсеты

### Бизнес-логика

Для каждой команды:

- Отбираются все игры, где команда была `домашней стороной` (`Games.hometeam`)
- Победа команды в этом матче
- Команда была андердогом (`is_upset_relative`)
- Подсчитывается:
  - Общее количество домашних игр с котировками
  - Количество домашних апсетов
  - `home_upset_rate` — процент домашних апсетов от всех домашних игр

### Отображение

- Добавляется признак попадания в плей-офф
- Выводится отсортированная таблица по `home_upset_rate` (топ-7)

---

## 4. Сводная таблица всех команд

### Бизнес-логика

Для каждой команды рассчитывается:

- Общее количество игр
- Количество апсетов
- Общий `upset_rate` (%)
- Количество домашних апсетов
- `home_upset_rate` (%)
- Статус попадания в плей-офф

### Отображение

- Используются все матчи сезона
- Таблица не сортируется — отображаются все команды (в алфавитном порядке или по `abbrev`)

---

## 5. Апсеты по стадиям сезона

### Бизнес-логика

Разбивка по типу игры (`gametype`):

- `1` — Preseason
- `2` — Regular Season
- `3` — Playoffs

Для каждой команды считается:

- Количество игр по каждой стадии
- Количество апсетов по каждой стадии
- `upset_rate` по каждой стадии

### Отображение

- Используется та же логика и проверка (`is_upset_relative`)
- Добавляется информация о статусе плей-офф
- Таблица с колонками:
  - `Team`, `Preseason Games`, `Preseason Upsets`
  - `Regular Games`, `Regular Upsets`
  - `Playoff Games`, `Playoff Upsets`
  - `Playoff` ✔️/—

---

## 6. Серии апсетов (Longest Upset Streaks)

### Бизнес-логика

Для каждой команды:

- Загружаются все матчи с котировками, отсортированные по дате
- Проверяется последовательность апсетов (победа + андердог)
- Подсчитывается максимальная длина подряд идущих апсетов (`max_upset_streak`)

### Отображение

- Используется функция `is_upset_relative`
- Учитываются только матчи с доступными котировками
- Добавляется флаг `Playoff`
- Таблица с колонками: `Team`, `Max Upset Streak`, `Playoff ✔️/—`